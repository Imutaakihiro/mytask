# アーキテクチャ設計

## 2024-01-02 - システム設計のノウハウと開発の流れ

### 質問
システム設計のノウハウも混ぜてほしい。どんな流れでアプリを作成するのか、名著を調査してきて、とにかく具体で方針を作成して。

### 回答
Clean Architectureとレイヤードアーキテクチャの原則に基づいた開発方針を作成しました。

**設計原則：**
1. **レイヤー分離の原則**
   - Presentation Layer (HTMX)
   - Application Layer (FastAPI)
   - Domain Layer (Models)
   - Infrastructure Layer (DB)

2. **依存関係の方向**
   - 外側のレイヤーは内側のレイヤーに依存
   - 内側のレイヤーは外側のレイヤーに依存しない

**開発アプローチ：**
- ボトムアップアプローチ: データベース → モデル → API → UI の順で実装
- 段階的開発: 小さく始めて段階的に拡張
- 頻繁な動作確認: 各ステップで必ず動作確認

### 重要なポイント
- Clean Architectureの原則を適用
- レイヤー分離で保守性を向上
- ボトムアップで段階的に実装
- 各ステップで動作確認

### 開発の流れ
1. **Phase 0**: プロジェクト基盤構築
2. **Phase 1**: データ層の構築（Infrastructure + Domain）
3. **Phase 2**: API層の構築（Application）
4. **Phase 3**: UI層の構築（Presentation）
5. **Phase 4**: 高度な機能

### 参考資料
- Clean Architecture (Robert C. Martin)
- Domain-Driven Design (Eric Evans)
- 段階的開発 / イテレーティブ開発

### 関連トピック
- [開発プロセス.md](./開発プロセス.md)
- [データベース設計.md](./データベース設計.md)

---

## 2024-01-02 - レイヤードアーキテクチャとは

### 質問
レイヤードアーキテクチャってない？

### 回答
レイヤードアーキテクチャは、アプリケーションを役割ごとの「層（レイヤー）」に分けて設計する手法です。

**このプロジェクトでの4層構造：**

```
┌─────────────────────────────────┐
│   Presentation Layer (HTMX)    │  ← ユーザーインターフェース
│   - templates/                  │    ユーザーが見る部分
│   - static/                     │
├─────────────────────────────────┤
│   Application Layer (FastAPI)   │  ← ビジネスロジック
│   - app/main.py                 │    APIエンドポイント
│   - app/routers/                │    リクエスト処理
├─────────────────────────────────┤
│   Domain Layer (Models)         │  ← データモデル
│   - app/models.py               │    ビジネスルール
│                                  │    データの構造
├─────────────────────────────────┤
│   Infrastructure Layer (DB)     │  ← データベース
│   - app/database.py             │    データの保存
│   - tasks.db                    │
└─────────────────────────────────┘
```

**各レイヤーの役割：**

1. **Presentation Layer（プレゼンテーション層）**
   - 役割: ユーザーインターフェース
   - ファイル: `templates/`, `static/`
   - 技術: HTMX、HTML、CSS
   - 例: タスク一覧の表示、フォーム送信

2. **Application Layer（アプリケーション層）**
   - 役割: ビジネスロジック、APIエンドポイント
   - ファイル: `app/main.py`, `app/routers/`
   - 技術: FastAPI
   - 例: `/api/tasks` エンドポイント、リクエスト処理

3. **Domain Layer（ドメイン層）**
   - 役割: データモデル、ビジネスルール
   - ファイル: `app/models.py`
   - 技術: Pydantic
   - 例: Taskモデル、バリデーションルール

4. **Infrastructure Layer（インフラストラクチャ層）**
   - 役割: データの永続化
   - ファイル: `app/database.py`, `tasks.db`
   - 技術: SQLite
   - 例: データベース接続、CRUD操作

**依存関係の方向（重要）：**

```
外側（Presentation） → 内側（Application） → 内側（Domain） → 内側（Infrastructure）
```

- 外側のレイヤーは内側のレイヤーに依存する
- 内側のレイヤーは外側のレイヤーに依存しない

**例：**
- ✅ FastAPI（Application）は Models（Domain）を使う
- ❌ Models（Domain）は FastAPI（Application）に依存しない

**レイヤードアーキテクチャのメリット：**

1. **保守性**: 各レイヤーが独立しているため変更しやすい
2. **テストしやすさ**: 各レイヤーを個別にテストできる
3. **再利用性**: 内側のレイヤーを他のプロジェクトでも使える
4. **理解しやすさ**: 役割が明確で理解しやすい

### 重要なポイント
- レイヤーごとに役割が明確
- 依存関係の方向が重要（外側→内側）
- 各レイヤーを独立して開発・テストできる
- 保守性と拡張性が向上

### 参考コード例

#### Presentation Layer（HTMX）
```html
<!-- templates/index.html -->
<button hx-get="/api/tasks" hx-target="#tasks">
  タスクを取得
</button>
```

#### Application Layer（FastAPI）
```python
# app/main.py
@app.get("/api/tasks")
async def get_tasks():
    tasks = get_all_tasks()  # Infrastructure Layerを呼ぶ
    return render_template("tasks.html", tasks=tasks)
```

#### Domain Layer（Models）
```python
# app/models.py
class Task(BaseModel):
    id: int
    title: str
    quadrant: int
```

#### Infrastructure Layer（Database）
```python
# app/database.py
def get_all_tasks():
    # SQLiteからデータを取得
    return tasks
```

### 関連トピック
- [開発プロセス.md](./開発プロセス.md)

