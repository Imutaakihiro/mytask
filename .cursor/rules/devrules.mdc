---
alwaysApply: true
---

# 開発方針：HTMX + FastAPI タスク管理アプリ

## 基本方針

### AIの役割
- **AIは自分で開発・実装しない**
- ユーザーがハンズオン形式でアプリを作成していく
- AIは以下のサポートを提供：
  - 技術的な説明・ガイド
  - コードの例示・参考実装
  - 質問への回答
  - エラーの原因説明と解決方法の提案
  - 次のステップの提案

### ユーザーの役割
- ユーザー自身がコードを書く
- ハンズオン形式で学習しながら実装
- 不明点があれば質問する

## 開発の進め方

### 1. 段階的な学習
- 最小限の例から始める
- 機能を一つずつ追加していく
- 各ステップで理解を深める

### 2. 実装の流れ
1. AIが次のステップを説明
2. 必要なコード例や参考実装を提示
3. ユーザーが実際にコードを書く
4. 質問やエラーがあればAIがサポート
5. 次のステップに進む

### 3. コードの提供方法
- AIは完全な実装を提供しない
- 必要な部分のコード例やテンプレートを提供
- ユーザーが自分で組み立てる

## プロジェクト概要

### アプリケーション
- **名前**: アイゼンハワー・マトリックスタスク管理アプリ
- **技術スタック**: HTMX + FastAPI + SQLite
- **目的**: HTMXとFastAPIの技術習得

### 主要機能
1. タスク管理（CRUD操作）
2. 4象限のマトリックス表示
3. ドラッグ&ドロップで象限間移動
4. Obsidian形式のMarkdownエクスポート

## 開発時の注意事項

### AIがすべきこと
- ✅ 技術的な説明
- ✅ コード例の提示
- ✅ 質問への回答
- ✅ エラーの原因説明
- ✅ 次のステップの提案

### AIがすべきでないこと
- ❌ 完全な実装を一気に作成
- ❌ ユーザーに確認せずにファイルを作成・編集
- ❌ ユーザーの学習を阻害する行為

### ユーザーが実装する際のサポート
- コードの一部やテンプレートを提供
- 実装のヒントやポイントを説明
- エラーが出た場合の原因と解決方法を提示

## システム設計のアプローチ

### 設計原則（Clean Architecture / レイヤードアーキテクチャ）

#### 1. レイヤー分離の原則
```
┌─────────────────────────────────┐
│   Presentation Layer (HTMX)    │  ← ユーザーインターフェース
├─────────────────────────────────┤
│   Application Layer (FastAPI)   │  ← ビジネスロジック
├─────────────────────────────────┤
│   Domain Layer (Models)         │  ← データモデル
├─────────────────────────────────┤
│   Infrastructure Layer (DB)     │  ← データベース
└─────────────────────────────────┘
```

**各レイヤーの役割：**
- **Presentation Layer**: HTMXテンプレート、UI表示
- **Application Layer**: FastAPIルーティング、リクエスト処理
- **Domain Layer**: データモデル（Pydantic）、ビジネスルール
- **Infrastructure Layer**: SQLite、データ永続化

#### 2. 依存関係の方向
- 外側のレイヤーは内側のレイヤーに依存する
- 内側のレイヤーは外側のレイヤーに依存しない
- 例: FastAPIはModelsに依存するが、ModelsはFastAPIに依存しない

### 開発アプローチ（段階的開発 / イテレーティブ開発）

#### 1. ボトムアップアプローチ
**データベース → モデル → API → UI の順で実装**

1. **データベース設計・作成**（Infrastructure Layer）
   - SQLiteテーブル設計
   - マイグレーションスクリプト作成

2. **データモデル作成**（Domain Layer）
   - Pydanticモデル定義
   - バリデーションルール定義

3. **API実装**（Application Layer）
   - FastAPIエンドポイント作成
   - CRUD操作の実装

4. **UI実装**（Presentation Layer）
   - HTMXテンプレート作成
   - インタラクション実装

#### 2. 各ステップでの確認ポイント
- **データベース**: テーブル構造が要件を満たしているか
- **モデル**: バリデーションが正しく動作するか
- **API**: エンドポイントが正しく動作するか（curl/Postmanで確認）
- **UI**: ユーザー操作が正しく動作するか

### 実装の流れ（具体的な手順）

#### Phase 0: プロジェクト基盤構築
**目的**: 開発環境とプロジェクト構造を整える

1. **プロジェクト構造の作成**
   ```
   プロジェクト/
   ├── app/
   │   ├── __init__.py
   │   ├── main.py          # FastAPIアプリケーション
   │   ├── models.py         # データモデル（Pydantic）
   │   ├── database.py       # データベース接続・操作
   │   └── routers/          # APIルーター
   ├── templates/            # HTMXテンプレート
   ├── static/              # CSS、JavaScript
   ├── tests/               # テストコード
   ├── requirements.txt
   └── README.md
   ```

2. **仮想環境とパッケージインストール**
   - 仮想環境作成
   - requirements.txtに必要なパッケージを定義
   - インストール

3. **最小限の動作確認**
   - FastAPIのHello World
   - HTMXの最小限の例

#### Phase 1: データ層の構築（Infrastructure + Domain）
**目的**: データの永続化とモデル定義

1. **データベース設計**
   - テーブル設計（要件定義書に基づく）
   - SQLスキーマ作成

2. **データベース初期化**
   - SQLiteデータベース作成
   - テーブル作成スクリプト

3. **データモデル定義（Pydantic）**
   - Taskモデル定義
   - バリデーションルール

4. **データアクセス層**
   - CRUD操作の関数定義
   - データベース接続管理

**確認方法**: 
- データベースに直接データを挿入して確認
- PythonスクリプトでCRUD操作をテスト

#### Phase 2: API層の構築（Application）
**目的**: ビジネスロジックとAPIエンドポイント

1. **FastAPIアプリケーション作成**
   - アプリケーションインスタンス
   - ミドルウェア設定

2. **APIエンドポイント実装（1つずつ）**
   - GET /api/tasks（一覧取得）
   - POST /api/tasks（作成）
   - GET /api/tasks/{id}（詳細取得）
   - PUT /api/tasks/{id}（更新）
   - DELETE /api/tasks/{id}（削除）

3. **各エンドポイントの動作確認**
   - curlコマンドまたはPostmanでテスト
   - エラーハンドリングの確認

**確認方法**:
- ブラウザで `/docs` にアクセスしてSwagger UIで確認
- curlコマンドで各エンドポイントをテスト

#### Phase 3: UI層の構築（Presentation）
**目的**: ユーザーインターフェースとインタラクション

1. **基本レイアウト作成**
   - HTMLテンプレート構造
   - 4象限のマトリックスレイアウト
   - Notion風のスタイリング

2. **HTMX統合（機能ごとに）**
   - タスク一覧表示（hx-get）
   - タスク追加フォーム（hx-post）
   - タスク編集（hx-put）
   - タスク削除（hx-delete）

3. **各機能の動作確認**
   - ブラウザで実際に操作
   - ネットワークタブでHTMXリクエストを確認

**確認方法**:
- ブラウザの開発者ツールでHTMXリクエストを確認
- 各操作が正しく動作するか確認

#### Phase 4: 高度な機能
**目的**: ドラッグ&ドロップとエクスポート機能

1. **ドラッグ&ドロップ実装**
   - Sortable.jsの統合
   - HTMXとの連携
   - 象限間移動の実装

2. **エクスポート機能**
   - Markdown生成ロジック
   - ダウンロード機能

### 各フェーズでのベストプラクティス

#### 1. 小さく始める（Small Steps）
- 一度に1つの機能だけを実装
- 動作確認してから次に進む
- エラーが出たらすぐに修正

#### 2. 動作確認を頻繁に行う
- 各ステップで必ず動作確認
- エラーは早めに発見・修正
- 動作する状態を保つ

#### 3. リファクタリングのタイミング
- 動作するコードができたらリファクタリング
- 重複コードを削減
- 可読性を向上

#### 4. エラーハンドリング
- 各レイヤーで適切なエラーハンドリング
- ユーザーに分かりやすいエラーメッセージ
- ログ出力でデバッグしやすく

### 学習の進め方（詳細版）

#### Phase 1: 基本機能（データ層 → API層 → UI層）
1. **プロジェクトセットアップ**
   - プロジェクト構造作成
   - 仮想環境・パッケージインストール
   - 最小限の動作確認

2. **データベース設計・作成**（Infrastructure Layer）
   - テーブル設計
   - SQLiteデータベース作成
   - 初期データ投入（オプション）

3. **データモデル作成**（Domain Layer）
   - Pydanticモデル定義
   - バリデーションルール

4. **データアクセス層**（Infrastructure Layer）
   - CRUD操作の関数
   - データベース接続管理

5. **API実装 - タスク一覧**（Application Layer）
   - GET /api/tasks エンドポイント
   - 動作確認

6. **UI実装 - タスク一覧表示**（Presentation Layer）
   - HTMXでタスク一覧表示
   - 動作確認

7. **API実装 - タスク追加**（Application Layer）
   - POST /api/tasks エンドポイント
   - 動作確認

8. **UI実装 - タスク追加フォーム**（Presentation Layer）
   - HTMXでタスク追加フォーム
   - 動作確認

9. **4象限のマトリックス表示**（Presentation Layer）
   - レイアウト作成
   - 象限ごとにタスクを表示

10. **API実装 - タスク編集・削除**（Application Layer）
    - PUT /api/tasks/{id}
    - DELETE /api/tasks/{id}
    - 動作確認

11. **UI実装 - タスク編集・削除**（Presentation Layer）
    - HTMXでタスク編集・削除
    - 動作確認

#### Phase 2: ドラッグ&ドロップ
12. **Sortable.jsの統合**（Presentation Layer）
    - Sortable.jsの読み込み
    - 基本的なドラッグ&ドロップ実装

13. **象限間移動の実装**（Application + Presentation Layer）
    - PATCH /api/tasks/{id} エンドポイント
    - HTMXとSortable.jsの連携
    - 動作確認

#### Phase 3: エクスポート
14. **Markdown生成ロジック**（Application Layer）
    - Obsidian形式のMarkdown生成
    - 動作確認

15. **ダウンロード機能**（Application + Presentation Layer）
    - GET /api/export エンドポイント
    - HTMXでダウンロード
    - 動作確認

### 各ステップでの学習ポイント

#### データ層
- SQLiteの使い方
- Pydanticモデルの定義方法
- データベース操作の基本

#### API層
- FastAPIの基本
- エンドポイントの設計
- リクエスト/レスポンスの処理
- エラーハンドリング

#### UI層
- HTMXの基本属性
- テンプレートエンジン（Jinja2）の使い方
- CSSでのレイアウト
- JavaScriptライブラリの統合

## 参考資料

### 要件定義・設計
- 要件定義書: `Docs/要件定義書.md`
- 技術スタック比較: `Docs/技術スタック比較.md`

### システム設計の名著・手法
- **Clean Architecture** (Robert C. Martin)
  - レイヤー分離の原則
  - 依存関係の方向
  
- **Domain-Driven Design** (Eric Evans)
  - ドメインモデルの重要性
  - ビジネスロジックの分離

- **段階的開発 / イテレーティブ開発**
  - 小さく始めて段階的に拡張
  - 動作確認を頻繁に行う
  - リファクタリングのタイミング

### 技術ドキュメント
- [HTMX公式ドキュメント](https://htmx.org/)
- [FastAPI公式ドキュメント](https://fastapi.tiangolo.com/)
- [Pydantic公式ドキュメント](https://docs.pydantic.dev/)
- [Sortable.js公式ドキュメント](https://sortablejs.github.io/Sortable/)
